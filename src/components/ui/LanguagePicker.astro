---
import { languages, defaultLang } from '@/i18n/ui';
import { Globe, ChevronDown } from 'lucide-react';
import { getLocalizedPath } from '@/i18n/utils';

interface Props {
  currentLang?: string;
}

const { currentLang = defaultLang } = Astro.props;

// 获取当前语言的显示名称
const currentLabel = languages[currentLang as keyof typeof languages] || languages[defaultLang];
const pathname = Astro.url.pathname;

// --- 核心逻辑修复 ---
// 1. 获取原始路径（去除语言前缀）
let originalPath = pathname;
const supportedLangs = Object.keys(languages).filter(lang => lang !== defaultLang);

for (const lang of supportedLangs) {
  // 检查路径是否以 /zh, /vi 等开头
  const prefix = `/${lang}`;
  if (originalPath === prefix || originalPath.startsWith(`${prefix}/`)) {
    originalPath = originalPath.slice(prefix.length);
    break;
  }
}

// 2. 确保路径以 / 开头（处理空字符串的情况）
if (!originalPath.startsWith('/')) {
  originalPath = '/' + originalPath;
}

// 调试日志：保存文件后，请查看 VS Code 的终端输出，确认 originalPath 是否正确
// console.log('LanguagePicker Debug:', { pathname, originalPath, currentLang });
---

<div class="relative group ml-4 z-50">
  <button 
    class="flex items-center space-x-1.5 text-slate-600 hover:text-blue-600 transition-colors py-2"
    aria-label="Select Language"
  >
    <Globe className="w-4 h-4" />
    <span class="text-sm font-medium">{currentLabel}</span>
    <ChevronDown className="w-3 h-3 opacity-50 group-hover:opacity-100 transition-opacity" />
  </button>
  
  <!-- Dropdown Menu -->
  <div class="absolute right-0 mt-1 w-40 bg-white rounded-xl shadow-xl border border-slate-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right translate-y-2 group-hover:translate-y-0">
    <div class="p-1.5">
      {Object.entries(languages).map(([lang, label]) => (
        <a
          href={getLocalizedPath(originalPath, lang)} 
          class={`flex items-center px-3 py-2 text-sm rounded-lg transition-colors ${
            currentLang === lang 
              ? 'bg-blue-50 text-blue-600 font-medium' 
              : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900'
          }`}
        >
          {label}
          {currentLang === lang && (
            <span class="ml-auto w-1.5 h-1.5 rounded-full bg-blue-600"></span>
          )}
        </a>
      ))}
    </div>
  </div>
</div>